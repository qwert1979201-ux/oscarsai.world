name: oscarsai

x-resource-config: &resource-config
    deploy:
        resources:
            limits:
                memory: ${DOCKER_MEMORY_LIMIT:-3584M}
                cpus: "${DOCKER_CPU_LIMIT:-1.0}"
            reservations:
                memory: ${DOCKER_MEMORY_RESERVATION:-512M}

services:
    redis:
        image: ccr.ccs.tencentyun.com/oscarsai/redis:8.2.2
        container_name: oscarsai-redis${DOCKER_CONTAINER_SUFFIX:-}
        restart: always
        environment:
            TZ: Asia/Shanghai
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            QUICK_START_MODE: ${QUICK_START_MODE:-false}
        ports:
            - "${REDIS_EXTERNAL_PORT:-}${REDIS_EXTERNAL_PORT:+:}6379"
        volumes:
            - ./docker/data/redis:/data
        networks:
            - oscarsai-network
        <<: *resource-config
        healthcheck:
            test: ["CMD-SHELL", "redis-cli -a $$REDIS_PASSWORD ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    postgres:
        image: ccr.ccs.tencentyun.com/oscarsai/postgres:17.6
        container_name: oscarsai-postgres${DOCKER_CONTAINER_SUFFIX:-}
        restart: always
        environment:
            TZ: Asia/Shanghai
            POSTGRES_USER: ${DB_USERNAME:-postgres}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
            POSTGRES_DB: ${DB_DATABASE:-oscarsai}
        ports:
            - "${POSTGRES_EXTERNAL_PORT:-}${POSTGRES_EXTERNAL_PORT:+:}5432"
        volumes:
            - ./docker/data/postgres/postgres_data:/var/lib/postgresql/data
        networks:
            - oscarsai-network
        <<: *resource-config
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres}"]
            interval: 10s
            timeout: 5s
            retries: 5

    nodejs:
        image: ccr.ccs.tencentyun.com/oscarsai/node:22.20.0
        container_name: oscarsai-nodejs${DOCKER_CONTAINER_SUFFIX:-}
        restart: on-failure:3
        working_dir: /oscarsai
        volumes:
            - ./:/oscarsai
            - /oscarsai/node_modules
            - /oscarsai/packages/api/node_modules
            - /oscarsai/packages/cli/node_modules
            - /oscarsai/packages/core/node_modules
            - /oscarsai/packages/web/oscarsai-ui/node_modules
            - /oscarsai/packages/web/@oscarsai/designer/node_modules
            - /oscarsai/packages/web/@oscarsai/hooks/node_modules
            - /oscarsai/packages/web/@oscarsai/http/node_modules
            - /oscarsai/packages/web/@oscarsai/i18n-config/node_modules
            - /oscarsai/packages/web/@oscarsai/layouts/node_modules
            - /oscarsai/packages/web/@oscarsai/nuxt/node_modules
            - /oscarsai/packages/web/@oscarsai/service/node_modules
            - /oscarsai/packages/web/@oscarsai/stores/node_modules
            - /oscarsai/packages/web/@oscarsai/storybook/node_modules
            - /oscarsai/packages/web/@oscarsai/ui/node_modules
            - /oscarsai/packages/web/@oscarsai/web-config/node_modules
            - /oscarsai/packages/@oscarsai/ai-sdk/node_modules
            - /oscarsai/packages/@oscarsai/base/node_modules
            - /oscarsai/packages/@oscarsai/cache/node_modules
            - /oscarsai/packages/@oscarsai/config/node_modules
            - /oscarsai/packages/@oscarsai/constants/node_modules
            - /oscarsai/packages/@oscarsai/db/node_modules
            - /oscarsai/packages/@oscarsai/decorators/node_modules
            - /oscarsai/packages/@oscarsai/dict/node_modules
            - /oscarsai/packages/@oscarsai/di/node_modules
            - /oscarsai/packages/@oscarsai/dto/node_modules
            - /oscarsai/packages/@oscarsai/errors/node_modules
            - /oscarsai/packages/@oscarsai/eslint-config/node_modules
            - /oscarsai/packages/@oscarsai/extension-sdk/node_modules
            - /oscarsai/packages/@oscarsai/logger/node_modules
            - /oscarsai/packages/@oscarsai/pipe/node_modules
            - /oscarsai/packages/@oscarsai/types/node_modules
            - /oscarsai/packages/@oscarsai/typescript-config/node_modules
            - /oscarsai/packages/@oscarsai/upgrade/node_modules
            - /oscarsai/packages/@oscarsai/utils/node_modules
            - /oscarsai/packages/@oscarsai/wechat-sdk/node_modules
        ports:
            - "${SERVER_PORT:-4090}:${SERVER_PORT:-4090}"
        environment:
            TZ: Asia/Shanghai
            SERVER_PORT: ${SERVER_PORT:-4090}
            QUICK_START_MODE: ${QUICK_START_MODE:-false}
            NPM_REGISTRY_URL: ${NPM_REGISTRY_URL:-}
            DB_USERNAME: ${DB_USERNAME:-postgres}
            DB_PASSWORD: ${DB_PASSWORD:-postgres}
            DB_DATABASE: ${DB_DATABASE:-oscarsai}
            DB_HOST: postgres
            DB_PORT: 5432
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
        command: |
            sh -c '
            set -e
            echo "ðŸš€ Starting oscarsai container..."

            if [ -n "$NPM_REGISTRY_URL" ]; then
            echo "ðŸ”§ Using custom registry: $NPM_REGISTRY_URL"
            if command -v npm >/dev/null 2>&1; then
                npm config set registry "$NPM_REGISTRY_URL"
            fi
            if command -v pnpm >/dev/null 2>&1; then
                pnpm config set registry "$NPM_REGISTRY_URL"
            fi
            else
            echo "âš ï¸ NPM_REGISTRY_URL not set, using default registry"
            fi

            if ! command -v pnpm >/dev/null 2>&1; then
            echo "ðŸ“¦ Installing pnpm..."
            npm install -g pnpm
            npm install -g pm2

            if [ -n "$NPM_REGISTRY_URL" ]; then
                pnpm config set registry "$NPM_REGISTRY_URL"
            fi
            fi

            echo "ðŸŽ¯ Starting oscarsai..."
            exec pnpm start --no-daemon
            '
        networks:
            - oscarsai-network
        <<: *resource-config
        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:${SERVER_PORT:-4090}/consoleapi/health || pnpm pm2 describe ${PM2_APP_NAME:-oscarsai-api} | grep -q 'online' || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 600s

networks:
    oscarsai-network:
        driver: bridge
